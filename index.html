<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Savings Bank - Dashboard</title>
    
    <!-- Google Fonts & Font Awesome Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">

    <!-- jsPDF Libraries for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* --- CSS STYLES --- */
        :root {
            --primary-color: #0a2540; --secondary-color: #f6f9fc; --accent-green: #28a745;
            --accent-red: #dc3545; --accent-blue: #007bff; --text-dark: #333;
            --text-light: #fff; --border-color: #e6e6e6; --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--secondary-color); color: var(--text-dark); display: flex; }

        #sidebar { position: fixed; top: 0; left: -250px; width: 250px; height: 100vh; background-color: var(--primary-color); color: var(--text-light); padding: 20px; transition: left 0.3s ease-in-out; z-index: 1000; }
        #sidebar.open { left: 0; }
        .sidebar-header { margin-bottom: 30px; font-size: 1.5rem; font-weight: 600; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 15px; }
        .nav-menu { list-style: none; }
        .nav-menu li a { display: flex; align-items: center; gap: 15px; color: var(--text-light); text-decoration: none; padding: 15px 10px; border-radius: 5px; margin-bottom: 10px; font-weight: 500; transition: background-color 0.2s; cursor: pointer; }
        .nav-menu li a:hover { background-color: var(--accent-blue); }
        .nav-menu li a i { width: 20px; text-align: center; }

        #main-content { flex-grow: 1; padding: 20px; }
        header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; background: #fff; padding: 15px 20px; border-radius: 8px; box-shadow: var(--shadow); }
        .header-left { display: flex; align-items: center; }
        #menu-toggle { font-size: 24px; background: none; border: none; cursor: pointer; margin-right: 20px; color: var(--primary-color); }
        .page-title { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); }
        .user-profile { font-weight: 600; color: var(--primary-color); }

        .summary-widgets { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .widget-card { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: var(--shadow); border-left: 5px solid; transition: border-color 0.3s; }
        .widget-card.green { border-color: var(--accent-green); }
        .widget-card.red { border-color: var(--accent-red); }
        .widget-card h3 { font-size: 0.9rem; color: #666; font-weight: 500; margin-bottom: 10px; }
        .widget-card .amount { font-size: 2rem; font-weight: 700; transition: color 0.3s; }
        .widget-card .amount.positive { color: var(--accent-green); }
        .widget-card .amount.negative { color: var(--accent-red); }

        .transaction-history-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .transaction-list-card { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: var(--shadow); }
        .transaction-list { list-style: none; max-height: 400px; overflow-y: auto; }
        .transaction-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 5px; border-bottom: 1px solid var(--border-color); position: relative; }
        .transaction-item:hover .delete-btn { opacity: 1; }
        .delete-btn { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #aaa; cursor: pointer; font-size: 1rem; opacity: 0; transition: opacity 0.2s, color 0.2s; }
        .delete-btn:hover { color: var(--accent-red); }
        .transaction-amount.cleared { color: var(--accent-blue); font-style: italic; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-overlay.show { display: flex; }
        .modal-content { background-color: #fff; padding: 30px; border-radius: 8px; width: 90%; max-width: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .modal-title { font-size: 1.5rem; margin-bottom: 20px; color: var(--primary-color); }
        .modal-warning { margin-bottom: 15px; line-height: 1.6; }
        .modal-subtitle { font-size: 1rem; font-weight: 600; margin-top: 20px; margin-bottom: 10px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; transition: background-color 0.2s, opacity 0.2s; }
        .btn:hover { opacity: 0.85; }
        .btn-primary { background-color: var(--primary-color); color: var(--text-light); }
        .btn-secondary { background-color: #ccc; color: var(--text-dark); }
        .btn-danger { background-color: var(--accent-red); color: var(--text-light); }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.6; }
        .btn-full { width: 100%; padding: 15px; margin-bottom: 15px; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 10px;}
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        #clear-expense-details { margin-top: 15px; padding: 10px; background-color: #f6f9fc; border-radius: 5px; border-left: 3px solid var(--accent-blue); }

        #notification-toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 15px 25px; border-radius: 8px; z-index: 3000; transition: bottom 0.5s ease-in-out; background-color: var(--accent-blue); color: #fff;}
        #notification-toast.show { bottom: 20px; }
    </style>
</head>
<body>

    <nav id="sidebar">
        <div class="sidebar-header">Savings Bank</div>
        <ul class="nav-menu">
            <li><a id="add-deposit-btn"><i class="fa-solid fa-circle-plus"></i> New Deposit</a></li>
            <li><a id="add-debit-btn"><i class="fa-solid fa-circle-minus"></i> New Expense</a></li>
            <li><a id="clear-expense-btn-nav"><i class="fa-solid fa-check-double"></i> Clear Expense</a></li>
            <li><a href="#transaction-history-section"><i class="fa-solid fa-list-ul"></i> History</a></li>
            <li><a id="account-settings-btn"><i class="fa-solid fa-sliders"></i> Settings</a></li>
        </ul>
    </nav>

    <div id="main-content">
        <header>
            <div class="header-left"><button id="menu-toggle">☰</button><h1 class="page-title">Dashboard</h1></div>
            <div class="user-profile" id="holder-name-display">Welcome, Guest</div>
        </header>

        <main>
            <section class="summary-widgets">
                <div class="widget-card green"><h3>Available Balance</h3><p class="amount positive" id="available-balance">₹0.00</p></div>
                <div class="widget-card red"><h3>Expenses (This Month)</h3><p class="amount negative" id="monthly-expenses">₹0.00</p></div>
                <div class="widget-card red"><h3>Total Uncleared Expenses</h3><p class="amount negative" id="amount-to-clear">₹0.00</p></div>
            </section>
            <section class="transaction-history-container" id="transaction-history-section">
                <div class="transaction-list-card"><h2>Credits / Deposits</h2><ul id="credit-list" class="transaction-list"></ul></div>
                <div class="transaction-list-card"><h2>Debits / Expenses</h2><ul id="debit-list" class="transaction-list"></ul></div>
                <div class="transaction-list-card"><h2>Cleared History</h2><ul id="cleared-list" class="transaction-list"></ul></div>
            </section>
        </main>
    </div>
    
    <!-- MODALS -->
    <div id="transaction-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title">New Transaction</h2>
            <form id="transaction-form">
                <input type="hidden" id="transaction-type">
                <div class="form-group"><label for="date">Date</label><input type="date" id="date" required></div>
                <div class="form-group"><label for="description">Description</label><input type="text" id="description" required></div>
                <div class="form-group"><label for="amount">Amount</label><input type="number" id="amount" min="0.01" step="0.01" required></div>
                <div class="modal-actions"><button type="button" class="btn btn-secondary" data-close>Cancel</button><button type="submit" class="btn btn-primary">Add</button></div>
            </form>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title">Settings</h2>
            <div class="form-group"><label for="holder-name-input">Account Holder Name</label><input type="text" id="holder-name-input" placeholder="Enter your name"></div>
            <h3 class="modal-subtitle">Data Management</h3>
            <button id="backup-btn" class="btn btn-primary btn-full"><i class="fa-solid fa-download"></i> Backup Data</button>
            <button id="restore-btn" class="btn btn-primary btn-full"><i class="fa-solid fa-upload"></i> Restore Data</button>
            <input type="file" id="restore-input" accept=".json" style="display: none;">
            <h3 class="modal-subtitle">Tools & Actions</h3>
            <button id="save-pdf-btn" class="btn btn-primary btn-full"><i class="fa-solid fa-file-pdf"></i> Save Statement as PDF</button>
            <button id="open-calculator-btn" class="btn btn-primary btn-full"><i class="fa-solid fa-calculator"></i> Open Calculator</button>
            <button id="reset-app-btn" class="btn btn-danger btn-full"><i class="fa-solid fa-triangle-exclamation"></i> Reset Application</button>
            <div class="modal-actions"><button type="button" class="btn btn-secondary" data-close>Cancel</button><button id="save-settings-btn" class="btn btn-primary">Save Settings</button></div>
        </div>
    </div>

    <div id="calculator-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="calculator-grid">
                <div class="calc-display" id="calc-display-element">0</div>
                <button class="calc-btn span-two" data-action="clear">AC</button><button class="calc-btn" data-action="delete">DEL</button><button class="calc-btn operator" data-action="operator">÷</button>
                <button class="calc-btn" data-action="number">7</button><button class="calc-btn" data-action="number">8</button><button class="calc-btn" data-action="number">9</button><button class="calc-btn operator" data-action="operator">×</button>
                <button class="calc-btn" data-action="number">4</button><button class="calc-btn" data-action="number">5</button><button class="calc-btn" data-action="number">6</button><button class="calc-btn operator" data-action="operator">-</button>
                <button class="calc-btn" data-action="number">1</button><button class="calc-btn" data-action="number">2</button><button class="calc-btn" data-action="number">3</button><button class="calc-btn operator" data-action="operator">+</button>
                <button class="calc-btn" data-action="number">0</button><button class="calc-btn" data-action="number">.</button><button class="calc-btn operator span-two" data-action="equals">=</button>
            </div>
             <div class="modal-actions"><button type="button" class="btn btn-secondary" data-close>Close Calculator</button></div>
        </div>
    </div>

    <div id="reset-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title">Confirm Reset</h2>
            <p class="modal-warning">This action is <strong>irreversible</strong> and will permanently delete all transaction data. To proceed, please type <strong>RESET</strong> in the box below.</p>
            <div class="form-group"><input type="text" id="reset-confirm-input" placeholder="Type RESET to confirm"></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" data-close>Cancel</button>
                <button id="reset-confirm-btn" class="btn btn-danger" disabled>Confirm Reset</button>
            </div>
        </div>
    </div>
    
    <div id="clear-expense-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title">Clear an Expense</h2>
            <div class="form-group">
                <label for="clear-expense-select">Select Expense to Clear</label>
                <select id="clear-expense-select"></select>
            </div>
            <div id="clear-expense-details" style="display: none;">
                <p><strong>Description:</strong> <span id="clear-desc"></span></p>
                <p><strong>Amount:</strong> <span id="clear-amount"></span></p>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" data-close>Cancel</button>
                <button id="clear-expense-confirm-btn" class="btn btn-primary" disabled><i class="fa-solid fa-check"></i> Mark as Paid</button>
            </div>
        </div>
    </div>

    <div id="notification-toast"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const $ = selector => document.querySelector(selector);
        const $$ = selector => document.querySelectorAll(selector);
        
        let transactions = JSON.parse(localStorage.getItem('transactions_v2')) || [];
        let settings = JSON.parse(localStorage.getItem('settings_v2')) || { holderName: 'Guest' };

        const saveData = () => {
            localStorage.setItem('transactions_v2', JSON.stringify(transactions));
            localStorage.setItem('settings_v2', JSON.stringify(settings));
        };
        
        const formatCurrency = amount => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amount);
        const formatDate = dateStr => new Date(dateStr).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        
        const showNotification = (message) => {
            const toast = $('#notification-toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        };

        const openModal = modalEl => modalEl.classList.add('show');
        const closeModal = modalEl => modalEl.classList.remove('show');

        const updateHolderNameDisplay = () => {
            $('#holder-name-display').textContent = `Welcome, ${settings.holderName}`;
            $('#holder-name-input').value = settings.holderName;
        };
        
        const renderTransactionList = (element, transactionData) => {
            element.innerHTML = transactionData.length === 0 ? `<li>No transactions recorded.</li>` : '';
            const sorted = [...transactionData].sort((a, b) => new Date(b.date) - new Date(a.date));
            sorted.forEach(t => {
                const isCleared = t.type === 'cleared';
                const amountClass = isCleared ? 'cleared' : t.type;
                const sign = t.type === 'deposit' ? '+' : '-';
                
                element.innerHTML += `
                    <li class="transaction-item">
                        <div><span class="transaction-description">${t.description}</span><br><span class="transaction-date">${formatDate(t.date)}</span></div>
                        <div class="transaction-amount ${amountClass}">${isCleared ? '' : sign}${formatCurrency(t.amount)}</div>
                        ${!isCleared ? `<button class="delete-btn" title="Delete" data-id="${t.id}"><i class="fa-solid fa-trash-can"></i></button>` : ''}
                    </li>`;
            });
        };

        const updateDashboard = () => {
            const allDeposits = transactions.filter(t => t.type === 'deposit');
            const allDebits = transactions.filter(t => t.type === 'debit');
            const allCleared = transactions.filter(t => t.type === 'cleared');

            const totalDeposits = allDeposits.reduce((s, t) => s + t.amount, 0);
            const totalDebits = allDebits.reduce((s, t) => s + t.amount, 0);
            
            $('#available-balance').textContent = formatCurrency(totalDeposits - totalDebits);

            const now = new Date();
            const monthlyFilter = t => { const d = new Date(t.date); return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear(); };
            const monthlyExpenses = allDebits.filter(monthlyFilter).reduce((s, t) => s + t.amount, 0);
            
            $('#monthly-expenses').textContent = formatCurrency(monthlyExpenses * -1);
            $('#amount-to-clear').textContent = formatCurrency(totalDebits * -1);

            renderTransactionList($('#credit-list'), allDeposits);
            renderTransactionList($('#debit-list'), allDebits);
            renderTransactionList($('#cleared-list'), allCleared);
        };
        
        const openClearExpenseModal = () => {
            const selectEl = $('#clear-expense-select');
            const detailsEl = $('#clear-expense-details');
            const confirmBtn = $('#clear-expense-confirm-btn');
            const debits = transactions.filter(t => t.type === 'debit');

            selectEl.innerHTML = '<option value="">-- Select an expense --</option>';
            detailsEl.style.display = 'none';
            confirmBtn.disabled = true;

            if (debits.length > 0) {
                debits.forEach(d => {
                    const option = document.createElement('option');
                    option.value = d.id;
                    option.textContent = `${d.description} (${formatCurrency(d.amount)})`;
                    selectEl.appendChild(option);
                });
            } else {
                selectEl.innerHTML = '<option value="">No expenses to clear</option>';
            }
            openModal($('#clear-expense-modal'));
        };

        const handleClearExpense = () => {
            const selectedId = parseInt($('#clear-expense-select').value);
            if (!selectedId) return;
            const expenseToClear = transactions.find(t => t.id === selectedId);
            if (!expenseToClear) return;

            transactions = transactions.filter(t => t.id !== selectedId);
            const clearedTransaction = { id: Date.now(), type: 'cleared', description: `Cleared: ${expenseToClear.description}`, amount: expenseToClear.amount, date: new Date().toISOString().slice(0, 10) };
            transactions.push(clearedTransaction);
            saveData();
            updateDashboard();
            closeModal($('#clear-expense-modal'));
            alert("Thanks for paying and its cleared!");
        };
        
        const generatePDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(20); doc.text("Savings Bank - Account Statement", 14, 22);
            doc.setFontSize(12); doc.text(`Account Holder: ${settings.holderName}`, 14, 30);
            doc.text(`Report Generated: ${new Date().toLocaleDateString()}`, 14, 38);
            
            const totalDeposits = transactions.filter(t => t.type === 'deposit').reduce((s, t) => s + t.amount, 0);
            const totalDebits = transactions.filter(t => t.type === 'debit').reduce((s, t) => s + t.amount, 0);

            doc.autoTable({ startY: 45, head: [['Summary', 'Amount']], body: [
                ['Total Deposits:', { content: formatCurrency(totalDeposits), styles: { halign: 'right' } }],
                ['Total Uncleared Expenses:', { content: formatCurrency(totalDebits), styles: { halign: 'right' } }],
                ['Available Balance:', { content: formatCurrency(totalDeposits - totalDebits), styles: { halign: 'right', fontStyle: 'bold' } }],
            ]});

            const creditData = transactions.filter(t => t.type === 'deposit').map(t => [formatDate(t.date), t.description, formatCurrency(t.amount)]);
            if(creditData.length > 0) doc.autoTable({ startY: doc.lastAutoTable.finalY + 10, head: [['Deposits - Date', 'Description', 'Amount']], body: creditData });

            const debitData = transactions.filter(t => t.type === 'debit').map(t => [formatDate(t.date), t.description, formatCurrency(t.amount)]);
            if(debitData.length > 0) doc.autoTable({ startY: doc.lastAutoTable.finalY + 10, head: [['Uncleared Expenses - Date', 'Description', 'Amount']], body: debitData });

            const clearedData = transactions.filter(t => t.type === 'cleared').map(t => [formatDate(t.date), t.description, formatCurrency(t.amount)]);
            if(clearedData.length > 0) doc.autoTable({ startY: doc.lastAutoTable.finalY + 10, head: [['Cleared History - Date', 'Description', 'Amount']], body: clearedData });
            
            doc.save(`Statement-${settings.holderName.replace(/\s/g, '_')}-${Date.now()}.pdf`);
        };

        const handleBackup = () => {
            const backupData = { settings: settings, transactions: transactions };
            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `savings_bank_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url);
            showNotification("Backup file downloaded!");
        };

        const handleRestore = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                if (confirm("Are you sure? This will overwrite all current data.")) {
                    try {
                        const restoredData = JSON.parse(e.target.result);
                        if (restoredData && Array.isArray(restoredData.transactions) && restoredData.settings) {
                            transactions = restoredData.transactions; settings = restoredData.settings;
                        } else if (Array.isArray(restoredData)) {
                            transactions = restoredData;
                        } else { throw new Error("Invalid file format."); }
                        saveData(); updateDashboard(); updateHolderNameDisplay(); showNotification("Data restored successfully!");
                    } catch (error) { showNotification("Error: Could not restore data from this file."); }
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        };

        const resetApplication = () => {
            transactions = []; settings = { holderName: 'Guest' }; saveData(); updateDashboard(); updateHolderNameDisplay(); closeModal($('#reset-modal'));
            showNotification("Application has been reset.");
        };

        class Calculator {
            constructor(displayElement) { this.displayElement = displayElement; this.clear(); }
            clear() { this.currentOperand = ''; this.previousOperand = ''; this.operation = undefined; this.updateDisplay(); }
            delete() { this.currentOperand = this.currentOperand.toString().slice(0, -1); this.updateDisplay(); }
            appendNumber(number) { if (number === '.' && this.currentOperand.includes('.')) return; this.currentOperand += number; this.updateDisplay(); }
            chooseOperation(operation) { if (this.currentOperand === '') return; if (this.previousOperand !== '') this.compute(); this.operation = operation; this.previousOperand = this.currentOperand; this.currentOperand = ''; }
            compute() { let computation; const prev = parseFloat(this.previousOperand); const current = parseFloat(this.currentOperand); if (isNaN(prev) || isNaN(current)) return; switch (this.operation) { case '+': computation = prev + current; break; case '-': computation = prev - current; break; case '×': computation = prev * current; break; case '÷': computation = prev / current; break; default: return; } this.currentOperand = computation; this.operation = undefined; this.previousOperand = ''; this.updateDisplay(); }
            updateDisplay() { this.displayElement.innerText = this.currentOperand || '0'; }
        }
        const calculator = new Calculator($('#calc-display-element'));

        // --- EVENT LISTENERS ---
        $('#menu-toggle').addEventListener('click', () => $('#sidebar').classList.toggle('open'));
        $('#account-settings-btn').addEventListener('click', () => openModal($('#settings-modal')));
        $('#save-settings-btn').addEventListener('click', () => { settings.holderName = $('#holder-name-input').value.trim() || 'Guest'; saveData(); updateHolderNameDisplay(); closeModal($('#settings-modal')); showNotification("Settings saved!"); });
        $('#backup-btn').addEventListener('click', handleBackup);
        $('#restore-btn').addEventListener('click', () => $('#restore-input').click());
        $('#restore-input').addEventListener('change', handleRestore);
        $('#save-pdf-btn').addEventListener('click', generatePDF);
        $('#open-calculator-btn').addEventListener('click', () => { closeModal($('#settings-modal')); openModal($('#calculator-modal')); });
        $('#reset-app-btn').addEventListener('click', () => { closeModal($('#settings-modal')); $('#reset-confirm-input').value = ''; $('#reset-confirm-btn').disabled = true; openModal($('#reset-modal')); });
        $('#reset-confirm-input').addEventListener('input', e => { $('#reset-confirm-btn').disabled = e.target.value !== 'RESET'; });
        $('#reset-confirm-btn').addEventListener('click', resetApplication);
        $('#clear-expense-btn-nav').addEventListener('click', openClearExpenseModal);
        $('#clear-expense-select').addEventListener('change', (e) => { const selectedId = parseInt(e.target.value); const detailsEl = $('#clear-expense-details'); const confirmBtn = $('#clear-expense-confirm-btn'); if (selectedId) { const expense = transactions.find(t => t.id === selectedId); $('#clear-desc').textContent = expense.description; $('#clear-amount').textContent = formatCurrency(expense.amount); detailsEl.style.display = 'block'; confirmBtn.disabled = false; } else { detailsEl.style.display = 'none'; confirmBtn.disabled = true; } });
        $('#clear-expense-confirm-btn').addEventListener('click', handleClearExpense);
        
        $$('#calculator-modal button').forEach(button => { button.addEventListener('click', () => { switch(button.dataset.action) { case 'number': calculator.appendNumber(button.innerText); break; case 'operator': calculator.chooseOperation(button.innerText); break; case 'equals': calculator.compute(); break; case 'clear': calculator.clear(); break; case 'delete': calculator.delete(); break; } }); });
        document.addEventListener('click', e => { const sidebar = $('#sidebar'); if (!sidebar.contains(e.target) && e.target !== $('#menu-toggle')) sidebar.classList.remove('open'); if (e.target.closest('.delete-btn')) { const id = Number(e.target.closest('.delete-btn').dataset.id); if (confirm('Delete this transaction?')) { transactions = transactions.filter(t => t.id !== id); saveData(); updateDashboard(); showNotification("Transaction deleted."); } } });
        $('#add-deposit-btn').addEventListener('click', () => { $('#transaction-type').value = 'deposit'; $('#transaction-form').reset(); $('#date').valueAsDate = new Date(); openModal($('#transaction-modal')); });
        $('#add-debit-btn').addEventListener('click', () => { $('#transaction-type').value = 'debit'; $('#transaction-form').reset(); $('#date').valueAsDate = new Date(); openModal($('#transaction-modal')); });
        $('#transaction-form').addEventListener('submit', e => { e.preventDefault(); const newTransaction = { id: Date.now(), type: $('#transaction-type').value, description: $('#description').value.trim(), amount: parseFloat($('#amount').value), date: $('#date').value }; if (!newTransaction.type || !newTransaction.date || !newTransaction.description || isNaN(newTransaction.amount) || newTransaction.amount <= 0) return; transactions.push(newTransaction); saveData(); updateDashboard(); closeModal($('#transaction-modal')); showNotification('Transaction added!'); });
        $$('[data-close]').forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.modal-overlay'))));

        // --- INITIAL LOAD ---
        updateHolderNameDisplay();
        updateDashboard();
    });
    </script>
</body>
</html>
